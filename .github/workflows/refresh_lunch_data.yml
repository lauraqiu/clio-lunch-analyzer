# Refresh lunch data every weekday at 2pm ET (19:00 UTC)
# So the hosted app can load from LUNCH_DATA_URL without calling Slack on every visit.
name: Refresh lunch data

on:
  schedule:
    # 19:00 UTC = 2pm ET (EST) / 3pm ET (EDT) — weekdays only
    - cron: "0 19 * * 1-5"
  workflow_dispatch:  # Allow manual run from Actions tab

jobs:
  refresh:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Check secrets are set
        env:
          SLACK_TOKEN: ${{ secrets.SLACK_TOKEN }}
          SLACK_COOKIE: ${{ secrets.SLACK_COOKIE }}
          CHANNEL_ID: ${{ secrets.CHANNEL_ID }}
        run: |
          if [ -z "$SLACK_TOKEN" ] && [ -z "$SLACK_COOKIE" ]; then
            echo "::error::Add either SLACK_TOKEN or SLACK_COOKIE in repo Settings → Secrets and variables → Actions (names must match exactly)"
            exit 1
          fi
          if [ -z "$CHANNEL_ID" ]; then
            echo "::error::Add CHANNEL_ID in repo Settings → Secrets and variables → Actions (name must match exactly)"
            exit 1
          fi
          echo "Secrets present (CHANNEL_ID length: ${#CHANNEL_ID})"

      - name: Run lunch data export
        env:
          SLACK_TOKEN: ${{ secrets.SLACK_TOKEN }}
          SLACK_COOKIE: ${{ secrets.SLACK_COOKIE }}
          CHANNEL_ID: ${{ secrets.CHANNEL_ID }}
        run: python scripts/update_lunch_data.py

      - name: Commit and push if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/lunch_data.json
          git diff --staged --quiet || (git commit -m "chore: refresh lunch data" && git push)
